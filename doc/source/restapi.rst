..
 (c) Copyright 2016 Hewlett Packard Enterprise Development LP
 (c) Copyright 2017 SUSE LLC

.. _rest-api:

REST API
========

General
-------

The BLL is registered as an endpoint in keystone with the name ``opsconsole``,
and the URL registered there is the one to use.  This is typically
``https://``\ *HOST*\ ``:9095/api/v1`` in a production environment.

The typical headers for json REST calls to OpenStack services are required:

| ``Accept: application/json``
| ``Content-Type: application/json``
| ``X-Auth-Token:`` *TOKEN*

.. _request-format:

Request Format
--------------
All REST calls to the BLL are http ``POST`` requests.  The payload is
a simple json structure with the following items:

* ``target``
      The BLL plugin that will service the request.  This field is required
      for new requests (i.e. those that are not job status requests)

* ``operation``
      The operation that will be executed within the BLL.

* ``action``
      Some operations strive to be REST-like and expect one of the standard
      REST operations in this field (``GET``, ``POST``, ``PUT`` or ``DELETE``).
      The action is only needed be a small number of operations in the BLL.

* ``region``
      A region name can be supplied in a multi-region environment for those
      requests that need a region.  This parameter is not needed in a
      single-region environment.

* ``job_status_request`` (boolean)
      To obtain the status of a long-running request, set the
      ``job_status_request`` entry to ``true``.  When using this option, the
      transaction id (``txn_id``) is a required parameter.

* ``txn_id``
      The transaction id to be used in a job status request.  A transaction id
      can also be supplied for new requests, but this usage is deprecated.

* other operation-specific data
      Depending on the operation, additional parameters may be needed in the
      request.  In the past, these additional elements, along with the
      ``operation``, were required to be placed into a nested ``data``
      dictionary, but that usage is deprecated and discouraged.

.. _response-format:

Response Format
---------------
The response from BLL requests is a json structure with the following items:

* ``txn_id``
     The transaction id generated by the request.  For long-running tasks,
     this value will be used in subsequent requests to obtain the job status.

* ``status``
     Status of the request: ``inprogress``, ``complete``, or ``fail``.  If
     the status is ``inprogress``, a ``job_status_request`` should be made to
     obtain the status of the given transaction.

* ``progress``
     A json structure containing the field ``percent_complete``, which is a
     number between 0 and 100 indicating how much of the work is done on the
     request.

* ``recommended_polling_interval``
     For long-running tasks, this is the recommended number of seconds to
     wait between job status requests.

* ``data``
     The data response of the request.  In an error scenario, this will
     contain an array with a single element containing a dictionary with
     the error message.  This unnecessary nesting will be removed in a
     future modification.


Examples
--------
There are a number browser plugins available for Chrome and Firefox for
executing REST requests directly in the browser and viewing the traffic.
IntelliJ and eclipse also have plugins for this as well.

.. highlight:: bash

The most common command-line tool is ``curl``.  An example of obtaining
a token and making a request::

    # Obtain a token
    $ curl https://192.168.245.10:9095/api/v1/auth_token \
        -H 'Content-Type: application/json' \
        -H 'Accept: application/json' \
        --data '{"username":"dev","password":"test"}'

    {"token": "af95fef3f7684dafa861628040a0fd21", "expires": "2016-09-12T23:37:51.892928+00:00"}

    # Get a project list
    $ curl https://192.168.245.10:9095/api/v1/bll \
        -H 'Content-Type: application/json' \
        -H 'Accept: application/json' \
        -H 'X-Auth-Token: af95fef3f7684dafa861628040a0fd21' \
        --data '{"target":"user_group","operation":"project_list"}'
    {"status": "complete", "txn_id": "a22e958f-b943-4e58-a221-cee912dfab41","starttime": 1473709738.243234, "duration": 1.4179999828338623, "progress": {"percentComplete": 100}, "endtime": 1473709739.661234, "data": [{"id": "0290918d30b245d0a39eb06a921e2dc3", "name": "admin"}, {"id": "091676b8f9594149be5e38f457dc7d77", "name": "glance-check"}, {"id": "131c45a104594e5ea9710b1c99aba4b7", "name": "kronos"}, {"id": "2cdec4259bee401f9cea3de90d32685d", "name": "services"}, {"id": "3358b3415e34414697fbcf6105704740", "name": "backup"}, {"id": "69943f70f4bd40debc746151bc5ae93f", "name": "swift-monitor"}, {"id": "699905facfa0479692a35336340b603e", "name": "cinderinternal"}, {"id": "719bf578ef9f4083959224b71e918d1f", "name": "swift-dispersion"}, {"id": "cdf1817b257249bb8c25d6c5d41b9b6c", "name": "octavia"}, {"id": "d55e31ca836547b48d28fbf897f78bf1", "name": "monitor"}, {"id": "d7952e7769274b61b8a1615939da6c6f", "name": "glance-swift"}, {"id": "f862ce8915474f12813866e0b845f971", "name": "demo"}]}

    # Create a new user
    $ curl https://192.168.245.10:9095/api/v1/bll \
        -H 'Content-Type: application/json' \
        -H 'Accept: application/json' \
        -H 'X-Auth-Token: af95fef3f7684dafa861628040a0fd21' \
        --data '{"target":"user_group","operation":"user_add","username":"john","password":"doe","project_name":"admin"}'
    {"status": "complete", "txn_id": "c9c05b00-c2ae-4575-a1c2-243de3f1c87d", "starttime": 1473710432.326117, "duration": 1.0908639430999756, "progress": {"percentComplete": 100}, "endtime": 1473710433.416981, "data": "008a0058d70b4ff39da8e80ff076f428"}

A better command-line tool that has intuitive command arguments and format
JSON output for humans is `httpie <https://httpie.org>`_. Here is a session
using `http-prompt <https://github.com/eliangcs/http-prompt>`_ that obtains
the same results::

    # Obtain a token
    $ http-prompt https://192.168.245.10:9095/api/v1/bll
    Version: 0.5.0
    https://192.168.245.10:9095/api/v1/bll> post ../auth_token username=dev password=test
    {
        "expires": "2016-09-12T23:37:51.892928+00:00",
        "token": "af95fef3f7684dafa861628040a0fd21"
    }
    https://192.168.245.10:9095/api/v1/bll> X-Auth-Token:af95fef3f7684dafa861628040a0fd21

    # Get a project list
    https://192.168.245.10:9095/api/v1/bll> post target=user_group operation=project_list
    {
        "data": [
            {
                "id": "0290918d30b245d0a39eb06a921e2dc3",
                "name": "admin"
            },
            {
                "id": "091676b8f9594149be5e38f457dc7d77",
                "name": "glance-check"
            },
            {
                "id": "131c45a104594e5ea9710b1c99aba4b7",
                "name": "kronos"
            },
            {
                "id": "2cdec4259bee401f9cea3de90d32685d",
                "name": "services"
            },
            {
                "id": "3358b3415e34414697fbcf6105704740",
                "name": "backup"
            },
            {
                "id": "69943f70f4bd40debc746151bc5ae93f",
                "name": "swift-monitor"
            },
            {
                "id": "699905facfa0479692a35336340b603e",
                "name": "cinderinternal"
            },
            {
                "id": "719bf578ef9f4083959224b71e918d1f",
                "name": "swift-dispersion"
            },
            {
                "id": "cdf1817b257249bb8c25d6c5d41b9b6c",
                "name": "octavia"
            },
            {
                "id": "d55e31ca836547b48d28fbf897f78bf1",
                "name": "monitor"
            },
            {
                "id": "d7952e7769274b61b8a1615939da6c6f",
                "name": "glance-swift"
            },
            {
                "id": "f862ce8915474f12813866e0b845f971",
                "name": "demo"
            }
        ],
        "duration": 0.4173750877380371,
        "endtime": 1473710137.649522,
        "progress": {
            "percentComplete": 100
        },
        "starttime": 1473710137.232147,
        "status": "complete",
        "txn_id": "39d3ef12-3b55-49c6-baa0-4dad62e8c4bf"
    }

    # Create a user
    https://192.168.245.10:9095/api/v1/bll> post target=user_group operation=user_add username=john password=doe project_name=admin
    {
        "data": "1713464877664fc69aad0bd1c0b5a80c",
        "duration": 1.4430599212646484,
        "endtime": 1473710330.7217,
        "progress": {
            "percentComplete": 100
        },
        "starttime": 1473710329.27864,
        "status": "complete",
        "txn_id": "965c2b27-0981-4c99-abfc-daeabef8a993"
    }
